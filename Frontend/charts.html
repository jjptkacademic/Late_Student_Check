<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢ - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .charts-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .chart-section h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        canvas {
            max-height: 400px;
        }
        .heatmap-container {
            overflow-x: auto;
        }
        .heatmap {
            display: grid;
            grid-template-columns: 100px repeat(6, 1fr);
            gap: 2px;
            margin: 20px 0;
        }
        .heatmap-cell {
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            font-weight: bold;
        }
        .heatmap-header {
            background: #4a90e2;
            color: white;
            font-weight: bold;
        }
        .heatmap-time {
            background: #f0f0f0;
            font-weight: bold;
            text-align: left;
            padding-left: 10px;
        }
        .heatmap-data {
            background: #e8f4f8;
            transition: all 0.3s;
        }
        .stats-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .stats-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingSpinner" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü...</p>
        </div>

        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <button id="backBtn" class="btn btn-icon">‚¨ÖÔ∏è</button>
                    <button id="homeBtn" class="btn btn-icon">üè†</button>
                    <h1>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢</h1>
                </div>
            </div>
        </header>

        <main class="charts-container">
            <!-- 1. ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á: ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô -->
            <div class="chart-section">
                <h2>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h2>
                <canvas id="dayChart"></canvas>
            </div>

            <!-- 2. ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢ -->
            <div class="chart-section">
                <h2>ü•ß ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢</h2>
                <canvas id="reasonChart"></canvas>
                <table class="stats-table" id="reasonTable">
                    <thead>
                        <tr>
                            <th>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                        </tr>
                    </thead>
                    <tbody id="reasonTableBody"></tbody>
                </table>
            </div>

            <!-- 3. ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô: ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="chart-section">
                <h2>üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
                <canvas id="lineChart"></canvas>
            </div>

            <!-- 4. Heat Map: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="chart-section">
                <h2>üî• Heat Map: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h2>
                <div class="heatmap-container">
                    <div class="heatmap" id="heatmap"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api-helper.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Navigation
        document.getElementById('backBtn').addEventListener('click', () => window.history.back());
        document.getElementById('homeBtn').addEventListener('click', () => window.location.href = 'index.html');

        // Load data
        let allRecords = [];

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏•‡∏∞ Heat Map
        const TIME_SLOTS = ['07:00-07:30', '07:31-07:45', '07:46-08:00', '08:01-08:15', '08:16-08:30', '08:31+'];
        const DAY_NAMES = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå'];

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì slot index ‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
        function getTimeSlotIndex(timeString) {
            if (!timeString) return -1;
            
            // ‡πÅ‡∏õ‡∏•‡∏á ISO datetime string ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
            let hour, minute;
            
            if (timeString.includes('T')) {
                // Format: "1899-12-30T14:21:56.000Z"
                // ‡πÉ‡∏ä‡πâ local time (‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏á timezone) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Google Sheets ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏á‡πÜ
                const date = new Date(timeString);
                hour = date.getHours();
                minute = date.getMinutes();
            } else {
                // Format: "14:21"
                [hour, minute] = timeString.split(':').map(Number);
            }
            
            const totalMinutes = hour * 60 + minute;

            // 07:00-07:30
            if (totalMinutes >= 420 && totalMinutes <= 450) return 0;
            // 07:31-07:45
            else if (totalMinutes >= 451 && totalMinutes <= 465) return 1;
            // 07:46-08:00
            else if (totalMinutes >= 466 && totalMinutes <= 480) return 2;
            // 08:01-08:15
            else if (totalMinutes >= 481 && totalMinutes <= 495) return 3;
            // 08:16-08:30
            else if (totalMinutes >= 496 && totalMinutes <= 510) return 4;
            // 08:31+
            else if (totalMinutes > 510) return 5;
            
            // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Å‡πà‡∏≠‡∏ô 07:00) ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö
            return -1;
        }

        async function loadData() {
            showLoading('loadingSpinner', 'üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü...');
            
            try {
                const response = await API.getLateRecords();
                if (response.success && response.data) {
                    allRecords = response.data;
                    
                    // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    if (allRecords.length > 0) {
                        console.log('Sample record:', allRecords[0]);
                        console.log('Total records:', allRecords.length);
                    }
                    
                    renderDayChart();
                    renderReasonChart();
                    renderLineChart();
                    renderHeatMap();
                } else {
                    throw new Error(response.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                hideLoading();
            }
        }

        // 1. ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á: ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô
        function renderDayChart() {
            const dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            const counts = new Array(7).fill(0);

            allRecords.forEach(record => {
                const date = new Date(record.late_date);
                const dayIndex = date.getDay();
                counts[dayIndex]++;
            });

            const ctx = document.getElementById('dayChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
                        data: counts,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // 2. ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢
        function renderReasonChart() {
            const reasonCounts = {};
            let total = 0;

            allRecords.forEach(record => {
                const reason = record.reason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
                total++;
            });

            const labels = Object.keys(reasonCounts);
            const data = Object.values(reasonCounts);

            const ctx = document.getElementById('reasonChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            const tableBody = document.getElementById('reasonTableBody');
            tableBody.innerHTML = '';
            labels.forEach((label, index) => {
                const count = data[index];
                const percentage = ((count / total) * 100).toFixed(1);
                tableBody.innerHTML += `
                    <tr>
                        <td>${label}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
        }

        // 3. ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô: ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        function renderLineChart() {
            const counts = new Array(TIME_SLOTS.length).fill(0);

            allRecords.forEach(record => {
                const slotIndex = getTimeSlotIndex(record.late_time);
                if (slotIndex >= 0) {
                    counts[slotIndex]++;
                } else {
                    // Debug: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á
                    const date = new Date(record.late_time);
                    console.log('Time not in slot:', record.late_time, 
                        '‚Üí Local time:', date.getHours() + ':' + date.getMinutes(),
                        '‚Üí UTC time:', date.getUTCHours() + ':' + date.getUTCMinutes());
                }
            });

            console.log('Line chart counts:', counts);

            const ctx = document.getElementById('lineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: TIME_SLOTS,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
                        data: counts,
                        borderColor: '#4a90e2',
                        backgroundColor: 'rgba(74, 144, 226, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // 4. Heat Map: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
        function renderHeatMap() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á heatmap data ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
            const heatmapData = {};
            DAY_NAMES.forEach(day => {
                heatmapData[day] = new Array(TIME_SLOTS.length).fill(0);
            });

            allRecords.forEach(record => {
                const date = new Date(record.late_date);
                const dayIndex = date.getDay();
                
                // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå=0, ‡πÄ‡∏™‡∏≤‡∏£‡πå=6)
                if (dayIndex === 0 || dayIndex === 6) return;
                
                const dayName = DAY_NAMES[dayIndex - 1];
                const slotIndex = getTimeSlotIndex(record.late_time);
                
                if (slotIndex >= 0) {
                    heatmapData[dayName][slotIndex]++;
                }
            });

            const heatmapEl = document.getElementById('heatmap');
            heatmapEl.innerHTML = '';

            // Header row
            heatmapEl.innerHTML += '<div class="heatmap-cell"></div>';
            TIME_SLOTS.forEach(slot => {
                heatmapEl.innerHTML += `<div class="heatmap-cell heatmap-header">${slot}</div>`;
            });

            // Data rows
            const maxCount = Math.max(...DAY_NAMES.flatMap(day => heatmapData[day])) || 1;
            
            DAY_NAMES.forEach(day => {
                heatmapEl.innerHTML += `<div class="heatmap-cell heatmap-time">${day}</div>`;
                heatmapData[day].forEach(count => {
                    const intensity = Math.min(count / maxCount, 1);
                    const color = `rgba(74, 144, 226, ${0.2 + intensity * 0.8})`;
                    heatmapEl.innerHTML += `<div class="heatmap-cell heatmap-data" style="background: ${color}">${count}</div>`;
                });
            });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
